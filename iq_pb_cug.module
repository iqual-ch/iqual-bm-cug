<?php
use \Drupal\Core\Access\AccessResult;
use \Drupal\Core\Form\FormStateInterface;
use \Drupal\node\NodeInterface;
use Symfony\Component\HttpFoundation\RedirectResponse;

function iq_pb_cug_node_access($node, $op, $account)
{
    if ($op == 'view' && $node->bundle() == 'iqbm_page') {
        $roleField = $node->field_iqcg_extranet;
        if ($roleField->count() > 0) {
            $iterator = $roleField->getIterator();
            $roles = [];
            while ($iterator->valid()) {
                $roles[] = $iterator->current()->target_id;
                $iterator->next();
            }
            $intersection = array_intersect($roles, $account->getRoles());
            if (count($intersection) > 0) {
                return AccessResult::allowed()->cachePerPermissions();
            } else {
                return AccessResult::forbidden()->cachePerPermissions();
            }
        }
    }
    return AccessResult::neutral();
}

// /**
//  * Implements hook_user_login_form_submit().
//  */
// function iq_pb_cug_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id)
// {
//     // echo 'registering handler';
//     $form['#submit'][] = '_iq_pb_cug_user_login_form_submit';
//     $form_state->setRedirect('<front>');
// }

// function _iq_pb_cug_user_login_form_submit(&$form, FormStateInterface $form_state)
// {
//     return;
//     // Set redirect to login form.
//     $user = \Drupal::currentUser();
//     $isExtranet = false;
//     foreach ($user->getRoles() as $role) {
//         $roleObj = \Drupal\user\Entity\Role::load($role);
//         if (strpos($roleObj->label(), 'Extranet') !== false) {
//             $isExtranet = true;
//         }
//     }
//     // die($isExtranet . '__');
//     if ($isExtranet) {
//         $url = \Drupal\node\Entity\Node::load(4046)->toUrl();

//         // echo $form_state->isRedirectDisabled() . '__';
//         $form_state->setRedirect('<front>');
//     }

// }

function iq_pb_cug_user_login(\Drupal\user\UserInterface $user)
{
    $isExtranet = false;
    foreach ($user->getRoles() as $role) {
        $roleObj = \Drupal\user\Entity\Role::load($role);
        if (strpos($roleObj->label(), 'Extranet') !== false) {
            $isExtranet = true;
        }
    }
    if ($isExtranet) {
        $response = new RedirectResponse(\Drupal\node\Entity\Node::load(4046)->toUrl()->toString());
        $response->send();
        exit();
    }
}
